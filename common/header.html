<script type="text/discourse-plugin" version="0.8">
  api.decorateWidget('post:after-cooked', helper => {
    const { settings } = helper.widget.attrs;
    const cooked = helper.widget.element();

    // 提取图片和备注信息（支持Markdown格式）
    function extractImages(html) {
      // 匹配Markdown格式的图片: ![备注|尺寸](图片URL) 或 ![备注](图片URL)
      const mdImageRegex = /!\[(.*?)\](?:\|\d+x\d+)?\((upload:\/\/.*?)\)/g;
      const matches = [...html.innerHTML.matchAll(mdImageRegex)];
      
      return matches.map(match => {
        return {
          src: match[2], // 图片URL
          note: match[1] || "" // 备注信息（alt文本）
        };
      });
    }

    // 生成多图对比布局
    function stackImages(images, direction) {
      if (images.length < 2) {
        return "至少需要两张图片进行对比";
      }
      
      let html = `<div class="multi-image-comparison" data-direction="${direction}">`;
      
      // 第一张图片作为基础
      html += `
        <div class="image-container first-image">
          <img src="${images[0].src}" alt="${images[0].note || '对比图'}">
          ${images[0].note ? `<div class="image-note">${images[0].note}</div>` : ''}
        </div>
      `;
      
      // 为每张后续图片生成对比滑块
      for (let i = 1; i < images.length; i++) {
        html += `
          <img-comparison-slider class="colored-slider" direction="${direction}">
            <img slot="first" src="${images[i-1].src}" alt="${images[i-1].note || '对比图'}">
            <img slot="second" src="${images[i].src}" alt="${images[i].note || '对比图'}">
            ${settings.handle_arrow_style === "solid" ? 
              '<svg slot="handle" class="grab-handle" style="cursor:grab" xmlns="http://www.w3.org/2000/svg" width="70" viewBox="-8 -3 16 6"><path stroke="#000" d="M -5 -2 L -7 0 L -5 2 M -5 -2 L -5 2 M 5 -2 L 7 0 L 5 2 M 5 -2 L 5 2" stroke-width="1" fill="#fff" vector-effect="non-scaling-stroke"></path></svg>' : 
              ''
            }
          </img-comparison-slider>
          ${images[i].note ? `<div class="image-note">${images[i].note}</div>` : ''}
        `;
      }
      
      html += `</div>`;
      return html;
    }

    // 初始化所有对比滑块
    cooked.querySelectorAll('div[data-image-comparison-slider]').forEach(slider => {
      const direction = slider.hasAttribute('data-direction-vertical') ? 'vertical' : 'horizontal';
      let imgs = extractImages(slider);
      let finalHTML = stackImages(imgs, direction);
      slider.innerHTML = finalHTML;
    });
  });

  // 自定义多图上传模态框
  api.onToolbarCreate(function(toolbar) {
    toolbar.addButton({
      trimLeading: true,
      id: "image-comparison-slider",
      group: "insertions",
      icon: settings.button_icon,
      title: "button_text",
      perform: e => {
        const modal = $(`
          <div class="image-comparison-modal">
            <h3>${settings.add_images_prompt}</h3>
            <div class="image-upload-container">
              <div class="image-slot" data-index="0">
                <label>图片 1 <input type="file" class="image-upload" accept="image/*"></label>
                <input type="text" class="image-note" placeholder="备注 (可选)">
              </div>
              <div class="image-slot" data-index="1">
                <label>图片 2 <input type="file" class="image-upload" accept="image/*"></label>
                <input type="text" class="image-note" placeholder="备注 (可选)">
              </div>
              <button class="add-image-slot">添加图片</button>
            </div>
            <div class="direction-options">
              <label><input type="radio" name="direction" value="horizontal" ${settings.default_direction === "horizontal" ? "checked" : ""}> 水平对比</label>
              <label><input type="radio" name="direction" value="vertical" ${settings.default_direction === "vertical" ? "checked" : ""}> 垂直对比</label>
            </div>
            <button class="insert-images">插入对比图</button>
          </div>
        `);
        
        // 添加图片槽功能
        modal.find('.add-image-slot').on('click', function() {
          const slots = modal.find('.image-slot');
          if (slots.length >= settings.max_images) {
            alert(`最多只能添加 ${settings.max_images} 张图片`);
            return;
          }
          
          const index = slots.length;
          modal.find('.add-image-slot').before(`
            <div class="image-slot" data-index="${index}">
              <label>图片 ${index + 1} <input type="file" class="image-upload" accept="image/*"></label>
              <input type="text" class="image-note" placeholder="备注 (可选)">
              <button class="remove-image-slot">移除</button>
            </div>
          `);
        });
        
        // 移除图片槽
        modal.on('click', '.remove-image-slot', function() {
          $(this).closest('.image-slot').remove();
          // 重新编号
          modal.find('.image-slot').each(function(index) {
            $(this).attr('data-index', index);
            $(this).find('label').first().text(`图片 ${index + 1}`);
          });
        });
        
        // 插入图片功能 - 生成Markdown格式
        modal.find('.insert-images').on('click', function() {
          const direction = modal.find('input[name="direction"]:checked').val();
          let html = `<div data-image-comparison-slider data-direction-${direction}>\n`;
          
          modal.find('.image-slot').each(function() {
            const fileInput = $(this).find('.image-upload')[0];
            const note = $(this).find('.image-note').val();
            
            if (fileInput.files && fileInput.files[0]) {
              // 实际应用中需要上传图片到服务器
              // 这里简化处理，假设图片已上传并返回URL
              const imageUrl = `upload://placeholder-image-${$(this).attr('data-index')}`;
              html += `  ![${note || '图片'}|690x388](${imageUrl})\n`;
            }
          });
          
          html += `</div>`;
          e.editor.insertHtml(html);
          bootbox.hideAll();
        });
        
        // 显示模态框
        bootbox.dialog({
          title: "创建图片对比滑块",
          message: modal,
          onEscape: true,
          backdrop: true
        });
      }
    });
  });

  // 设置翻译
  let translations = I18n.translations[I18n.currentLocale()].js;
  if (!translations) {
    translations = {};
  }
  if (!translations.composer) {
    translations.composer = {};
  }
  translations.button_text = settings.button_text;
  translations.composer.add_images_prompt = settings.add_images_prompt;
</script>